---
# This role deploys the magento containers

 # Make sure we have git installed
    - name: Install git
      yum:
        name: 
          - git
        state: latest
    
    # clone the repository
    - name: Cloning the repository
      git:
        repo: "{{ repository }}"
        dest: "{{ clone_location }}"
        version: "{{ version }}"

    # make sure we have the desired directories in the mount location
    - name: Make sure we have desired directories
      file:
        path: "{{ root_directory }}/{{ item }}"
        state: directory
        mode: "0755"  
      with_items: "{{ dirNames }}"

    # copy the config files to the machine
    - name: Copy the config files to the machine
      block:
        - name: copy the config files
          copy:
            src: "{{ clone_location }}/config"
            dest: "{{ root_directory }}"
            remote_src: yes
      rescue:
        - name: Removing the repository
          file:
            path: "{{ clone_location }}"
            state: absent

    # make sure we have a magento directory in the appl repo
    - name: Make sure we have a magento application directory
      file:
        path: "{{ root_directory }}/appl/magento"
        state: directory
        mode: "0755"  

    # check if the directory is empty if so we need to retrieve the files
    - name: Check if magento application directory is empty
      find:
        paths: "{{ root_directory }}/appl/magento"
      register: filesFound

    # make sure we have the magento application files if the directory is empty
    - name: Retrieve magento application files
      shell: "composer create-project --no-interaction --repository-url https://repo.magento.com/ magento/project-community-edition {{ root_directory }}/appl/magento/"
      when: filesFound.matched == 0

    # create the magento network
    - name: Create magento network network
      docker_network:
        name: magento

    - name: Create a mariaDB container
      docker_container:
        name: db
        image: 'mariadb:10.7'
        ports: 
          - '3306'
        env:
          MYSQL_ROOT_PASSWORD: "magento2"
          MYSQL_DATABASE: "magento2"
          MYSQL_USER: "magento2"
          MYSQL_PASSWORD: "magento2"
        hostname: "db.magento2.docker"
        volumes:
          - "{{ root_directory }}/data/db:/var/lib/mysql"
          - "{{ root_directory }}/config/mysql/conf.d:/etc/mysql/conf.d"
        networks:
          - name: magento
            aliases:
              - "db.magento2.docker"

    # create a mailhog container
    - name: Create a mailhog container
      docker_container:
        restart_policy: 'always'
        name: mail
        image: 'mailhog/mailhog:v1.0.1'
        ports: 
          - '1025:1025'
          - '8025:8025'
        hostname: "mail.magento2.docker"
        networks:
          - name: magento
            aliases:
              - "mail.magento2.docker"

    # create the tls container
    - name: Create a tls container
      docker_container:
        restart_policy: 'always'
        name: tls
        image: 'magento/magento-cloud-docker-nginx:1.9-1.2'
        ports: 
          - '433:433'
        hostname: "tls.magento2.docker"
        networks:
          - name: magento
            aliases:
              - "tls.magento2.docker"


    # remove the cloned repository
    - name: Removing the repository
      file:
        path: "{{ clone_location }}"
        state: absent

...
